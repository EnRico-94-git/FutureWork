<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${colaborador.id != null} ? 'Editar Colaborador' : 'Novo Colaborador'">Future Work</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div th:replace="fragments/header :: header"></div>

<main class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header">
                    <h4 th:text="${colaborador.id != null} ? 'Editar Colaborador' : 'Novo Colaborador'"
                        class="mb-0"></h4>
                </div>
                <div class="card-body">
                    <!-- üîß CORRE√á√ÉO: Adicionar th:action e th:object corretamente -->
                    <form th:action="@{/colaboradores/salvar}"
                          th:object="${colaborador}"
                          method="post"
                          id="formColaborador">

                        <!-- Campo hidden para ID (importante para edi√ß√£o) -->
                        <input type="hidden" th:field="*{id}" />

                        <!-- üîß MENSAGEM DE ERRO GERAL -->
                        <div th:if="${erro}" class="alert alert-danger alert-dismissible fade show" role="alert">
                            <span th:text="${erro}"></span>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>

                        <!-- Nome -->
                        <div class="mb-3">
                            <label for="nome" class="form-label">Nome *</label>
                            <input type="text"
                                   class="form-control"
                                   id="nome"
                                   th:field="*{nome}"
                                   th:classappend="${#fields.hasErrors('nome')} ? 'is-invalid' : ''"
                                   required
                                   minlength="2"
                                   maxlength="100"
                                   placeholder="Digite o nome completo" />
                            <div th:if="${#fields.hasErrors('nome')}" class="invalid-feedback">
                                <span th:errors="*{nome}"></span>
                            </div>
                        </div>

                        <!-- Email -->
                        <div class="mb-3">
                            <label for="email" class="form-label">Email *</label>
                            <input type="email"
                                   class="form-control"
                                   id="email"
                                   th:field="*{email}"
                                   th:classappend="${#fields.hasErrors('email')} ? 'is-invalid' : ''"
                                   required
                                   placeholder="exemplo@email.com" />
                            <div th:if="${#fields.hasErrors('email')}" class="invalid-feedback">
                                <span th:errors="*{email}"></span>
                            </div>
                        </div>

                        <!-- Habilidades -->
                        <div class="mb-3">
                            <label for="habilidades" class="form-label">Habilidades *</label>
                            <textarea class="form-control"
                                      id="habilidades"
                                      th:field="*{habilidades}"
                                      th:classappend="${#fields.hasErrors('habilidades')} ? 'is-invalid' : ''"
                                      rows="3"
                                      required
                                      maxlength="500"
                                      placeholder="Ex: Java, Spring Boot, Oracle, Docker"></textarea>
                            <div class="form-text">
                                Liste as principais habilidades separadas por v√≠rgula (m√°ximo 500 caracteres)
                            </div>
                            <div th:if="${#fields.hasErrors('habilidades')}" class="invalid-feedback">
                                <span th:errors="*{habilidades}"></span>
                            </div>
                        </div>

                        <div class="row">
                            <!-- Modelo de Trabalho -->
                            <div class="col-md-6 mb-3">
                                <label for="modeloTrabalho" class="form-label">Modelo de Trabalho *</label>
                                <!-- üîß CORRE√á√ÉO CR√çTICA: th:value="${modelo.name()}" -->
                                <select class="form-select"
                                        id="modeloTrabalho"
                                        th:field="*{modeloTrabalho}"
                                        th:classappend="${#fields.hasErrors('modeloTrabalho')} ? 'is-invalid' : ''"
                                        required>
                                    <option value="">Selecione...</option>
                                    <option th:each="modelo : ${modelosTrabalho}"
                                            th:value="${modelo.name()}"
                                            th:text="${modelo.name()}"></option>
                                </select>
                                <div th:if="${#fields.hasErrors('modeloTrabalho')}" class="invalid-feedback">
                                    <span th:errors="*{modeloTrabalho}"></span>
                                </div>
                            </div>

                            <!-- N√≠vel de IA -->
                            <div class="col-md-6 mb-3">
                                <label for="nivelIA" class="form-label">N√≠vel de IA *</label>
                                <!-- üîß CORRE√á√ÉO CR√çTICA: th:value="${nivel.name()}" -->
                                <select class="form-select"
                                        id="nivelIA"
                                        th:field="*{nivelIA}"
                                        th:classappend="${#fields.hasErrors('nivelIA')} ? 'is-invalid' : ''"
                                        required>
                                    <option value="">Selecione...</option>
                                    <option th:each="nivel : ${niveisIA}"
                                            th:value="${nivel.name()}"
                                            th:text="${nivel.name()}"></option>
                                </select>
                                <div th:if="${#fields.hasErrors('nivelIA')}" class="invalid-feedback">
                                    <span th:errors="*{nivelIA}"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Bot√µes -->
                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a th:href="@{/colaboradores}" class="btn btn-secondary me-md-2">
                                <i class="bi bi-x-circle"></i> Cancelar
                            </a>
                            <button type="submit" class="btn btn-primary" id="btnSubmit">
                                <span th:text="${colaborador.id != null} ? 'üíæ Atualizar' : '‚ûï Criar'"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- üîß CARD DE DEBUG (remover em produ√ß√£o) -->
            <div class="card mt-3" th:if="${#fields.hasErrors('*')}">
                <div class="card-header bg-danger text-white">
                    ‚ö†Ô∏è Erros de Valida√ß√£o Detectados
                </div>
                <div class="card-body">
                    <ul class="mb-0">
                        <li th:each="err : ${#fields.detailedErrors()}" th:text="${err}"></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</main>

<div th:replace="fragments/footer :: footer"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

<!-- üîß SCRIPT DE DEBUG E VALIDA√á√ÉO -->
<script>
    // Prevenir m√∫ltiplos submits
    document.getElementById('formColaborador').addEventListener('submit', function(e) {
        const btn = document.getElementById('btnSubmit');
        btn.disabled = true;
        btn.innerHTML = '‚è≥ Salvando...';

        // Debug: mostrar dados que ser√£o enviados
        console.log('=== FORMUL√ÅRIO SENDO ENVIADO ===');
        const formData = new FormData(e.target);
        for (let [key, value] of formData.entries()) {
            console.log(key + ': ' + value);
        }
    });

    // Contador de caracteres para habilidades
    const habilidadesTextarea = document.getElementById('habilidades');
    if (habilidadesTextarea) {
        const maxLength = 500;
        const counterDiv = document.createElement('small');
        counterDiv.className = 'form-text';
        counterDiv.id = 'charCounter';
        habilidadesTextarea.parentNode.appendChild(counterDiv);

        function updateCounter() {
            const remaining = maxLength - habilidadesTextarea.value.length;
            counterDiv.textContent = remaining + ' caracteres restantes';
            if (remaining < 50) {
                counterDiv.classList.add('text-danger');
                counterDiv.classList.remove('text-muted');
            } else {
                counterDiv.classList.add('text-muted');
                counterDiv.classList.remove('text-danger');
            }
        }

        habilidadesTextarea.addEventListener('input', updateCounter);
        updateCounter();
    }

    // Valida√ß√£o de email em tempo real
    const emailInput = document.getElementById('email');
    if (emailInput) {
        emailInput.addEventListener('blur', function() {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (this.value && !emailRegex.test(this.value)) {
                this.classList.add('is-invalid');
            } else {
                this.classList.remove('is-invalid');
            }
        });
    }

    console.log('‚úÖ Formul√°rio de colaboradores carregado');
</script>
</body>
</html>